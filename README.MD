# BOC Rate Reminder

## 📌 项目简介
> ⚠️ 使用前请阅读 [免责声明](DISCLAIMER.md)
**BOC Rate Reminder** 是一个基于 Python 构建的 **外汇汇率订阅与提醒系统**。  
其核心功能是 **自动化抓取中国银行牌价**，并通过 **定时调度** 实现：

1. **每日汇率推送**：用户可订阅指定币种，每日定时收到最新汇率邮件。  
2. **阈值提醒**：用户可设定汇率目标，当达到或超过条件时，立即收到通知。  

系统使用 **APScheduler** 作为调度器，结合 **MySQL** 作为数据存储，**SMTP 邮件服务** 作为通知渠道，并支持图表可视化。

---

## 🏗️ 系统架构

```
            ┌─────────────┐
            │  Scheduler  │  APScheduler 调度任务
            └─────┬───────┘
                  │ 定时任务
                  ▼
        ┌──────────────────┐
        │ Spider 爬虫模块  │  抓取中国银行汇率
        └─────────┬────────┘
                  │ 数据写入
                  ▼
        ┌──────────────────┐
        │  MySQL 数据库    │  存储汇率、订阅、阈值
        └─────────┬────────┘
                  │ 查询与分析
                  ▼
        ┌──────────────────┐
        │ HTML & Chart 模块│  渲染邮件模板 & 生成走势图
        └─────────┬────────┘
                  │ 生成邮件内容
                  ▼
        ┌──────────────────┐
        │ Mail 邮件模块    │  SMTP 推送到用户邮箱
        └──────────────────┘
```

---

## 🗂️ 目录结构

```
boc_rate_reminder-release-version/
├── main.py                  # 主入口，调度和核心逻辑
├── requirements.txt         # Python 依赖
├── Dockerfile               # Docker 构建文件
├── .dockerignore            # Docker 忽略清单
├── html_template/
│   ├── daily_template.html  # 每日订阅邮件 HTML 模板
│   └── threshold_template.html # 阈值提醒邮件 HTML 模板
└── lib/
    ├── chart_helper.py      # 生成走势图表
    ├── db_client.py         # MySQL 封装，增删查改
    ├── html_helper.py       # 模板渲染与替换
    ├── log_helper.py        # 日志打印
    ├── mail_helper.py       # 邮件发送
    ├── spider.py            # 爬虫，抓取汇率数据
    ├── utils.py             # 工具函数（数值转换等）
    └── __init__.py
```

---

## 📦 模块说明

### 1. **main.py**
- 项目入口，加载环境变量与调度器。  
- 使用 `BackgroundScheduler` 注册定时任务：  
  - 定时抓取并写入数据库。  
  - 定时生成并推送每日邮件。  
  - 实时检测阈值订阅，触发提醒邮件。  
- 使用 `ThreadPoolExecutor` 提升并发执行效率。  

### 2. **lib/spider.py**
- 核心爬虫模块，抓取中国银行外汇牌价。  
- 解析页面数据，提取汇率信息（现汇买入、现钞卖出等）。  
- 返回结构化字典，供数据库写入。  

### 3. **lib/db_client.py**
- MySQL 数据库操作封装：  
  - `insert_xchg_rate` → 插入汇率数据  
  - `get_threshold_sub` → 查询阈值订阅  
  - `get_ccy_xchg_rate_by_date` → 查询历史汇率  
  - `update_threshold_sub` → 更新订阅状态  
  - `get_daily_list` → 获取每日订阅用户  

### 4. **lib/chart_helper.py**
- 使用 `matplotlib` 绘制走势图表。  
- 将最近一段时间的汇率变化绘制为折线图，嵌入邮件 HTML。  

### 5. **lib/html_helper.py**
- 邮件内容生成：  
  - `generate_daily_html` → 渲染每日推送邮件。  
  - `replace_threshold_template` → 渲染阈值提醒邮件。  
- 结合 HTML 模板 + 数据，输出完整 HTML 字符串。  

### 6. **lib/mail_helper.py**
- SMTP 邮件发送模块。  
- 支持带图表的 HTML 邮件。  
- 出错时日志打印。  

### 7. **lib/utils.py**
- 工具函数集合：  
  - 汇率数值转换 (`conv_to_float`)。  
  - 时间戳转换等。  

---

## 🗄️ 数据库设计

### `exchange_rates`
存储抓取到的汇率数据（多币种 + 时间序列）。

```sql
CREATE TABLE `exchange_rates` (
  `currency_name` varchar(50) NOT NULL,
  `remittance_buy_price` decimal(12,6),
  `cash_buy_price` decimal(12,6),
  `remittance_sell_price` decimal(12,6),
  `cash_sell_price` decimal(12,6),
  `bank_conversion_price` decimal(12,6),
  `publish_timestamp` int NOT NULL,
  `fetched_at` int NOT NULL,
  PRIMARY KEY (`currency_name`,`publish_timestamp`)
);
```

### `daily_rate_subscriptions`
用户每日订阅表，存储用户邮箱与币种。

```sql
CREATE TABLE `daily_rate_subscriptions` (
  `user_mail` varchar(255) NOT NULL,
  `currency_name` varchar(20) NOT NULL,
  `active` tinyint(1) NOT NULL,
  PRIMARY KEY (`user_mail`,`currency_name`)
);
```

### `rate_threshold_subscriptions`
汇率阈值提醒表，支持用户为某币种设置触发条件。

```sql
CREATE TABLE `rate_threshold_subscriptions` (
  `user_mail` varchar(255),
  `uid` binary(36) NOT NULL,
  `currency_name` varchar(30) NOT NULL,
  `target_exchange_rate` varchar(255),
  `target_type` enum('remittance_buy_price','cash_buy_price','remittance_sell_price','cash_sell_price','bank_conversion_price'),
  `last_triggered_at` int,
  `trigger_count` int,
  `active` tinyint(1) NOT NULL,
  PRIMARY KEY (`uid`)
);
```

---

## ⚙️ 环境配置

### 安装依赖
```bash
pip install -r requirements.txt
```

### 配置环境变量（`.env` 文件）
```ini
TIME_ZONE=Asia/Shanghai

# 数据库配置
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASS=your_db_password
DB_NAME=exchange_db

# 邮件服务配置
SMTP_SERVER=smtp.example.com
SMTP_PORT=465
SMTP_USER=your_email@example.com
SMTP_PASS=your_password
```

---

## ⚡ 快速使用（Quick Start）

如果你想快速启动整个项目，推荐使用 Docker：  

1. **准备数据库**
   - 确认 MySQL 已经启动，并执行建表语句（见上文“数据库设计”）。
   - 创建数据库 `rate_data`。

2. **创建 `.env` 文件**（参考上文环境变量配置）。  

3. **构建并运行容器**：
   ```bash
   docker build -t boc_rate_reminder .
   docker run -d --env-file .env boc_rate_reminder
   ```

4. **验证服务是否运行成功**  
   - 检查数据库 `exchange_rates` 是否有新数据。  
   - 检查订阅用户是否收到邮件。  

---

## 🚀 运行与部署

### 本地运行
1. 初始化数据库（执行 SQL 建表语句）。  
2. 启动程序：
   ```bash
   python main.py
   ```

### Docker 部署
```bash
# 构建镜像（本地构建）
docker build -t boc_rate_reminder .
docker run -d --env-file .env boc_rate_reminder

# 或者从 Docker Hub 拉取远程镜像
docker pull shidaijiya/boc_rate_reminder:latest
docker run -d --env-file .env shidaijiya/boc_rate_reminder:latest
```


---

## 🔄 工作流程

1. **爬虫**：定时抓取中国银行汇率。  
2. **存储**：写入 MySQL 数据库。  
3. **调度**：APS 定时任务负责每日推送 & 阈值检查。  
4. **生成邮件**：HTML 模板 + 图表。  
5. **邮件推送**：通过 SMTP 发送到用户邮箱。  

---

## 🧩 常见问题

### 1. 邮件未能发送？
- 检查 `.env` 中 SMTP 配置是否正确。  
- 确认邮箱开启 **SMTP/IMAP 服务**。  
- 检查防火墙是否拦截 `465` 或 `587` 端口。  

### 2. 数据库连接失败？
- 确认 `.env` 配置与 MySQL 实际一致。  
- 确认表已建立，且用户有权限。  

### 3. 阈值提醒未触发？
- 检查 `rate_threshold_subscriptions.active` 是否为 `1`。  
- 检查目标汇率是否与实际抓取数据匹配。  

---
