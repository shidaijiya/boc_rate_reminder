# BOC Rate Reminder

## ğŸ“Œ é¡¹ç›®ç®€ä»‹
> âš ï¸ ä½¿ç”¨å‰è¯·é˜…è¯» [å…è´£å£°æ˜](DISCLAIMER.md)
**BOC Rate Reminder** æ˜¯ä¸€ä¸ªåŸºäº Python æ„å»ºçš„ **å¤–æ±‡æ±‡ç‡è®¢é˜…ä¸æé†’ç³»ç»Ÿ**ã€‚  
å…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯ **è‡ªåŠ¨åŒ–æŠ“å–ä¸­å›½é“¶è¡Œç‰Œä»·**ï¼Œå¹¶é€šè¿‡ **å®šæ—¶è°ƒåº¦** å®ç°ï¼š

1. **æ¯æ—¥æ±‡ç‡æ¨é€**ï¼šç”¨æˆ·å¯è®¢é˜…æŒ‡å®šå¸ç§ï¼Œæ¯æ—¥å®šæ—¶æ”¶åˆ°æœ€æ–°æ±‡ç‡é‚®ä»¶ã€‚  
2. **é˜ˆå€¼æé†’**ï¼šç”¨æˆ·å¯è®¾å®šæ±‡ç‡ç›®æ ‡ï¼Œå½“è¾¾åˆ°æˆ–è¶…è¿‡æ¡ä»¶æ—¶ï¼Œç«‹å³æ”¶åˆ°é€šçŸ¥ã€‚  

ç³»ç»Ÿä½¿ç”¨ **APScheduler** ä½œä¸ºè°ƒåº¦å™¨ï¼Œç»“åˆ **MySQL** ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œ**SMTP é‚®ä»¶æœåŠ¡** ä½œä¸ºé€šçŸ¥æ¸ é“ï¼Œå¹¶æ”¯æŒå›¾è¡¨å¯è§†åŒ–ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Scheduler  â”‚  APScheduler è°ƒåº¦ä»»åŠ¡
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å®šæ—¶ä»»åŠ¡
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Spider çˆ¬è™«æ¨¡å—  â”‚  æŠ“å–ä¸­å›½é“¶è¡Œæ±‡ç‡
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æ•°æ®å†™å…¥
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  MySQL æ•°æ®åº“    â”‚  å­˜å‚¨æ±‡ç‡ã€è®¢é˜…ã€é˜ˆå€¼
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æŸ¥è¯¢ä¸åˆ†æ
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ HTML & Chart æ¨¡å—â”‚  æ¸²æŸ“é‚®ä»¶æ¨¡æ¿ & ç”Ÿæˆèµ°åŠ¿å›¾
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ ç”Ÿæˆé‚®ä»¶å†…å®¹
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Mail é‚®ä»¶æ¨¡å—    â”‚  SMTP æ¨é€åˆ°ç”¨æˆ·é‚®ç®±
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ ç›®å½•ç»“æ„

```
boc_rate_reminder-release-version/
â”œâ”€â”€ main.py                  # ä¸»å…¥å£ï¼Œè°ƒåº¦å’Œæ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ requirements.txt         # Python ä¾èµ–
â”œâ”€â”€ Dockerfile               # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ .dockerignore            # Docker å¿½ç•¥æ¸…å•
â”œâ”€â”€ html_template/
â”‚   â”œâ”€â”€ daily_template.html  # æ¯æ—¥è®¢é˜…é‚®ä»¶ HTML æ¨¡æ¿
â”‚   â””â”€â”€ threshold_template.html # é˜ˆå€¼æé†’é‚®ä»¶ HTML æ¨¡æ¿
â””â”€â”€ lib/
    â”œâ”€â”€ chart_helper.py      # ç”Ÿæˆèµ°åŠ¿å›¾è¡¨
    â”œâ”€â”€ db_client.py         # MySQL å°è£…ï¼Œå¢åˆ æŸ¥æ”¹
    â”œâ”€â”€ html_helper.py       # æ¨¡æ¿æ¸²æŸ“ä¸æ›¿æ¢
    â”œâ”€â”€ log_helper.py        # æ—¥å¿—æ‰“å°
    â”œâ”€â”€ mail_helper.py       # é‚®ä»¶å‘é€
    â”œâ”€â”€ spider.py            # çˆ¬è™«ï¼ŒæŠ“å–æ±‡ç‡æ•°æ®
    â”œâ”€â”€ utils.py             # å·¥å…·å‡½æ•°ï¼ˆæ•°å€¼è½¬æ¢ç­‰ï¼‰
    â””â”€â”€ __init__.py
```

---

## ğŸ“¦ æ¨¡å—è¯´æ˜

### 1. **main.py**
- é¡¹ç›®å…¥å£ï¼ŒåŠ è½½ç¯å¢ƒå˜é‡ä¸è°ƒåº¦å™¨ã€‚  
- ä½¿ç”¨ `BackgroundScheduler` æ³¨å†Œå®šæ—¶ä»»åŠ¡ï¼š  
  - å®šæ—¶æŠ“å–å¹¶å†™å…¥æ•°æ®åº“ã€‚  
  - å®šæ—¶ç”Ÿæˆå¹¶æ¨é€æ¯æ—¥é‚®ä»¶ã€‚  
  - å®æ—¶æ£€æµ‹é˜ˆå€¼è®¢é˜…ï¼Œè§¦å‘æé†’é‚®ä»¶ã€‚  
- ä½¿ç”¨ `ThreadPoolExecutor` æå‡å¹¶å‘æ‰§è¡Œæ•ˆç‡ã€‚  

### 2. **lib/spider.py**
- æ ¸å¿ƒçˆ¬è™«æ¨¡å—ï¼ŒæŠ“å–ä¸­å›½é“¶è¡Œå¤–æ±‡ç‰Œä»·ã€‚  
- è§£æé¡µé¢æ•°æ®ï¼Œæå–æ±‡ç‡ä¿¡æ¯ï¼ˆç°æ±‡ä¹°å…¥ã€ç°é’å–å‡ºç­‰ï¼‰ã€‚  
- è¿”å›ç»“æ„åŒ–å­—å…¸ï¼Œä¾›æ•°æ®åº“å†™å…¥ã€‚  

### 3. **lib/db_client.py**
- MySQL æ•°æ®åº“æ“ä½œå°è£…ï¼š  
  - `insert_xchg_rate` â†’ æ’å…¥æ±‡ç‡æ•°æ®  
  - `get_threshold_sub` â†’ æŸ¥è¯¢é˜ˆå€¼è®¢é˜…  
  - `get_ccy_xchg_rate_by_date` â†’ æŸ¥è¯¢å†å²æ±‡ç‡  
  - `update_threshold_sub` â†’ æ›´æ–°è®¢é˜…çŠ¶æ€  
  - `get_daily_list` â†’ è·å–æ¯æ—¥è®¢é˜…ç”¨æˆ·  

### 4. **lib/chart_helper.py**
- ä½¿ç”¨ `matplotlib` ç»˜åˆ¶èµ°åŠ¿å›¾è¡¨ã€‚  
- å°†æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ±‡ç‡å˜åŒ–ç»˜åˆ¶ä¸ºæŠ˜çº¿å›¾ï¼ŒåµŒå…¥é‚®ä»¶ HTMLã€‚  

### 5. **lib/html_helper.py**
- é‚®ä»¶å†…å®¹ç”Ÿæˆï¼š  
  - `generate_daily_html` â†’ æ¸²æŸ“æ¯æ—¥æ¨é€é‚®ä»¶ã€‚  
  - `replace_threshold_template` â†’ æ¸²æŸ“é˜ˆå€¼æé†’é‚®ä»¶ã€‚  
- ç»“åˆ HTML æ¨¡æ¿ + æ•°æ®ï¼Œè¾“å‡ºå®Œæ•´ HTML å­—ç¬¦ä¸²ã€‚  

### 6. **lib/mail_helper.py**
- SMTP é‚®ä»¶å‘é€æ¨¡å—ã€‚  
- æ”¯æŒå¸¦å›¾è¡¨çš„ HTML é‚®ä»¶ã€‚  
- å‡ºé”™æ—¶æ—¥å¿—æ‰“å°ã€‚  

### 7. **lib/utils.py**
- å·¥å…·å‡½æ•°é›†åˆï¼š  
  - æ±‡ç‡æ•°å€¼è½¬æ¢ (`conv_to_float`)ã€‚  
  - æ—¶é—´æˆ³è½¬æ¢ç­‰ã€‚  

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### `exchange_rates`
å­˜å‚¨æŠ“å–åˆ°çš„æ±‡ç‡æ•°æ®ï¼ˆå¤šå¸ç§ + æ—¶é—´åºåˆ—ï¼‰ã€‚

```sql
CREATE TABLE `exchange_rates` (
  `currency_name` varchar(50) NOT NULL,
  `remittance_buy_price` decimal(12,6),
  `cash_buy_price` decimal(12,6),
  `remittance_sell_price` decimal(12,6),
  `cash_sell_price` decimal(12,6),
  `bank_conversion_price` decimal(12,6),
  `publish_timestamp` int NOT NULL,
  `fetched_at` int NOT NULL,
  PRIMARY KEY (`currency_name`,`publish_timestamp`)
);
```

### `daily_rate_subscriptions`
ç”¨æˆ·æ¯æ—¥è®¢é˜…è¡¨ï¼Œå­˜å‚¨ç”¨æˆ·é‚®ç®±ä¸å¸ç§ã€‚

```sql
CREATE TABLE `daily_rate_subscriptions` (
  `user_mail` varchar(255) NOT NULL,
  `currency_name` varchar(20) NOT NULL,
  `active` tinyint(1) NOT NULL,
  PRIMARY KEY (`user_mail`,`currency_name`)
);
```

### `rate_threshold_subscriptions`
æ±‡ç‡é˜ˆå€¼æé†’è¡¨ï¼Œæ”¯æŒç”¨æˆ·ä¸ºæŸå¸ç§è®¾ç½®è§¦å‘æ¡ä»¶ã€‚

```sql
CREATE TABLE `rate_threshold_subscriptions` (
  `user_mail` varchar(255),
  `uid` binary(36) NOT NULL,
  `currency_name` varchar(30) NOT NULL,
  `target_exchange_rate` varchar(255),
  `target_type` enum('remittance_buy_price','cash_buy_price','remittance_sell_price','cash_sell_price','bank_conversion_price'),
  `last_triggered_at` int,
  `trigger_count` int,
  `active` tinyint(1) NOT NULL,
  PRIMARY KEY (`uid`)
);
```

---

## âš™ï¸ ç¯å¢ƒé…ç½®

### å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ`.env` æ–‡ä»¶ï¼‰
```ini
TIME_ZONE=Asia/Shanghai

# æ•°æ®åº“é…ç½®
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASS=your_db_password
DB_NAME=exchange_db

# é‚®ä»¶æœåŠ¡é…ç½®
SMTP_SERVER=smtp.example.com
SMTP_PORT=465
SMTP_USER=your_email@example.com
SMTP_PASS=your_password
```

---

## âš¡ å¿«é€Ÿä½¿ç”¨ï¼ˆQuick Startï¼‰

å¦‚æœä½ æƒ³å¿«é€Ÿå¯åŠ¨æ•´ä¸ªé¡¹ç›®ï¼Œæ¨èä½¿ç”¨ Dockerï¼š  

1. **å‡†å¤‡æ•°æ®åº“**
   - ç¡®è®¤ MySQL å·²ç»å¯åŠ¨ï¼Œå¹¶æ‰§è¡Œå»ºè¡¨è¯­å¥ï¼ˆè§ä¸Šæ–‡â€œæ•°æ®åº“è®¾è®¡â€ï¼‰ã€‚
   - åˆ›å»ºæ•°æ®åº“ `rate_data`ã€‚

2. **åˆ›å»º `.env` æ–‡ä»¶**ï¼ˆå‚è€ƒä¸Šæ–‡ç¯å¢ƒå˜é‡é…ç½®ï¼‰ã€‚  

3. **æ„å»ºå¹¶è¿è¡Œå®¹å™¨**ï¼š
   ```bash
   docker build -t boc_rate_reminder .
   docker run -d --env-file .env boc_rate_reminder
   ```

4. **éªŒè¯æœåŠ¡æ˜¯å¦è¿è¡ŒæˆåŠŸ**  
   - æ£€æŸ¥æ•°æ®åº“ `exchange_rates` æ˜¯å¦æœ‰æ–°æ•°æ®ã€‚  
   - æ£€æŸ¥è®¢é˜…ç”¨æˆ·æ˜¯å¦æ”¶åˆ°é‚®ä»¶ã€‚  

---

## ğŸš€ è¿è¡Œä¸éƒ¨ç½²

### æœ¬åœ°è¿è¡Œ
1. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆæ‰§è¡Œ SQL å»ºè¡¨è¯­å¥ï¼‰ã€‚  
2. å¯åŠ¨ç¨‹åºï¼š
   ```bash
   python main.py
   ```

### Docker éƒ¨ç½²
```bash
# æ„å»ºé•œåƒï¼ˆæœ¬åœ°æ„å»ºï¼‰
docker build -t boc_rate_reminder .
docker run -d --env-file .env boc_rate_reminder

# æˆ–è€…ä» Docker Hub æ‹‰å–è¿œç¨‹é•œåƒ
docker pull shidaijiya/boc_rate_reminder:latest
docker run -d --env-file .env shidaijiya/boc_rate_reminder:latest
```


---

## ğŸ”„ å·¥ä½œæµç¨‹

1. **çˆ¬è™«**ï¼šå®šæ—¶æŠ“å–ä¸­å›½é“¶è¡Œæ±‡ç‡ã€‚  
2. **å­˜å‚¨**ï¼šå†™å…¥ MySQL æ•°æ®åº“ã€‚  
3. **è°ƒåº¦**ï¼šAPS å®šæ—¶ä»»åŠ¡è´Ÿè´£æ¯æ—¥æ¨é€ & é˜ˆå€¼æ£€æŸ¥ã€‚  
4. **ç”Ÿæˆé‚®ä»¶**ï¼šHTML æ¨¡æ¿ + å›¾è¡¨ã€‚  
5. **é‚®ä»¶æ¨é€**ï¼šé€šè¿‡ SMTP å‘é€åˆ°ç”¨æˆ·é‚®ç®±ã€‚  

---

## ğŸ§© å¸¸è§é—®é¢˜

### 1. é‚®ä»¶æœªèƒ½å‘é€ï¼Ÿ
- æ£€æŸ¥ `.env` ä¸­ SMTP é…ç½®æ˜¯å¦æ­£ç¡®ã€‚  
- ç¡®è®¤é‚®ç®±å¼€å¯ **SMTP/IMAP æœåŠ¡**ã€‚  
- æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦æ‹¦æˆª `465` æˆ– `587` ç«¯å£ã€‚  

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ
- ç¡®è®¤ `.env` é…ç½®ä¸ MySQL å®é™…ä¸€è‡´ã€‚  
- ç¡®è®¤è¡¨å·²å»ºç«‹ï¼Œä¸”ç”¨æˆ·æœ‰æƒé™ã€‚  

### 3. é˜ˆå€¼æé†’æœªè§¦å‘ï¼Ÿ
- æ£€æŸ¥ `rate_threshold_subscriptions.active` æ˜¯å¦ä¸º `1`ã€‚  
- æ£€æŸ¥ç›®æ ‡æ±‡ç‡æ˜¯å¦ä¸å®é™…æŠ“å–æ•°æ®åŒ¹é…ã€‚  

---
